# ðŸ“‹ AnÃ¡lisis Forense de Logs - Telephony-Core
**Fecha:** 2026-01-19 12:51:57  
**SesiÃ³n:** 1768837909.919  
**Modo:** voicebot_quintero_query  
**ANI:** 966247067 â†’ **DNIS:** 9001

---

## 1) CONTEXTO GENERAL DEL FLUJO

**Tipo de llamada:** Inbound

**Dominio/Bot:** voicebot_quintero_query (Quintero â€“ ConfirmaciÃ³n)

**Objetivo del flujo:** Greeting â†’ Captura de RUT (LISTEN_RUT)

**Componentes activos:**
- Engine V3 (inbound)
- Dominio Quintero (phased-capsule)
- Asterisk ARI (Stasis + Snoop + ExternalMedia)
- STT Realtime (OpenAI gpt-4o-mini-transcribe)
- Redis (buffer incremental)

---

## 2) SECUENCIA CRONOLÃ“GICA RESUMIDA

**T0** â†’ Canal entra a Stasis correctamente  
**T1** â†’ Snoop RX-only creado y activo (1768837909.920)  
**T2** â†’ Dominio Quintero ejecuta greeting (audio estÃ¡tico)  
**T3** â†’ Playback se ejecuta y finaliza correctamente  
**T4** â†’ Dominio abre LISTEN_RUT (silent=false, skipInput=false)  
**T5** â†’ Engine inicializa STT + ExternalMedia  
**T6** â†’ Audio sÃ­ llega al STT (RX confirmado)  
**T7** â†’ OpenAI recibe audio + commits periÃ³dicos  
**T8** â†’ OpenAI devuelve transcripciÃ³n vacÃ­a ("")  
**T9** â†’ Dominio recibe NO_INPUT  
**T10** â†’ Llamada termina sin captura de audio Ãºtil

---

## 3) COSAS QUE FUNCIONAN CORRECTAMENTE

âœ… **[ARI]** Canal entra a Stasis sin error  
âœ… **[SNOOP]** Snoop RX-only creado y cableado correctamente (1768837909.920)  
âœ… **[ENGINE]** Playback ejecutado y escuchable (greeting)  
âœ… **[DOMAIN]** Fases Quintero cargadas y ejecutadas correctamente  
âœ… **[STT PIPELINE]**
- UDP RTP activo
- Audio RX recibido (size=160 repetido)
- OpenAI conectado y sesiÃ³n creada  
âœ… **[INCREMENTAL]** Commits periÃ³dicos ejecutÃ¡ndose cada 2s

---

## 4) ERRORES Y ANOMALÃAS DETECTADAS

âŒ **[STT / OpenAI]** TranscripciÃ³n vacÃ­a con audio presente  
ðŸ“Œ **Evidencia:**
```
ðŸŽ§ [STT][RX] Audio recibido (realtime) { size: 160 }
ðŸŽ¯ [OpenAI V3] TranscripciÃ³n completada: ""
```

âŒ **[VAD / Incremental]** Voz detectada como speaking=true pero NO confirmada como voz Ãºtil  
ðŸ“Œ **Evidencia:**
```
ðŸŽ¤ [USER_AUDIO_RX] { speaking: true }
âš ï¸ [INCREMENTAL RUT] VAD no detectÃ³ voz
```

âŒ **[DOMAIN FLOW]** NO_INPUT pese a audio continuo  
ðŸ“Œ **Evidencia:**
```
Processing Event: NO_INPUT in State: LISTEN_RUT
```

---

## 5) COMPORTAMIENTOS SOSPECHOSOS / RIESGOS

âš ï¸ **[AUDIO DIRECTION]** Audio llega, pero es semÃ¡nticamente "silencio" para el STT
- RX constante
- speaking=true
- transcripciÃ³n siempre vacÃ­a

âš ï¸ **[VAD/STT DESACOPLAMIENTO]** VAD y STT estÃ¡n desacoplados
- VAD usa Snoop (1768837909.920)
- STT recibe ExternalMedia
- Ambos reciben audio, pero no coinciden en detecciÃ³n de voz Ãºtil

âš ï¸ **[COMMIT SIN SEÃ‘AL]** Commit periÃ³dico funciona, pero sin seÃ±al vÃ¡lida
- El problema NO es falta de commit
- Es contenido del audio

---

## 6) CAUSA RAÃZ (ROOT CAUSE)

ðŸŽ¯ **Causa raÃ­z:**
El audio capturado por ExternalMedia es tÃ©cnicamente vÃ¡lido (RTP), pero no contiene seÃ±al de voz inteligible para el modelo STT (problema de formato, direcciÃ³n de audio o mezcla), por lo que OpenAI transcribe silencio.

**No es ausencia de audio.**  
**No es problema de dominio.**  
**No es problema de incremental.**  
**Es calidad/direcciÃ³n del audio entregado al STT.**

---

## 7) IMPACTO REAL EN EL USUARIO FINAL

ðŸ“ž **Impacto:**
El usuario escucha el saludo, habla normalmente, pero el bot no reconoce nada, entra en silencio lÃ³gico y finalmente corta la llamada.

**Desde el usuario:**
> "Hablo, pero el bot no me escucha."

---

## 8) QUÃ‰ NO ES EL PROBLEMA

ðŸš« **No es:**
- El dominio Quintero
- Las fases (LISTEN_RUT estÃ¡ bien abierta)
- silent o skipInput
- Incremental STT
- Commit de audio
- ConexiÃ³n a OpenAI
- Redis
- Playback / barge-in

**Todo eso funciona correctamente.**

---

## 9) RECOMENDACIONES TÃ‰CNICAS (SIN IMPLEMENTAR)

ðŸ› ï¸ **Recomendaciones:**

1. **Verificar DIRECCIÃ“N del audio**
   - Confirmar que ExternalMedia recibe audio del caller, no del bot.
   - Revisar `direction: 'both'` en ExternalMedia (lÃ­nea 418 voice-engine.js)

2. **Verificar CODEC real enviado al STT**
   - Î¼-law vs linear16 vs sample rate real.
   - Validar conversiÃ³n RTP â†’ base64

3. **Probar grabaciÃ³n cruda del RTP recibido**
   - Guardar 1â€“2 segundos del stream y escucharlo.
   - Comparar con audio del Snoop

4. **Aislar Snoop vs ExternalMedia**
   - Confirmar que ambos reciben exactamente la misma seÃ±al.
   - Verificar que el bridge no estÃ¡ mezclando direcciones

5. **No tocar engine hasta validar audio crudo**
   - Cualquier cambio ahora serÃ­a a ciegas.

---

## 10) RESUMEN EJECUTIVO FINAL

El sistema sÃ­ escucha audio a nivel RTP, pero el STT recibe silencio semÃ¡ntico.  
El problema no estÃ¡ en el dominio ni en el engine, sino en quÃ© audio exacto llega a ExternalMedia.  
Hasta no validar el audio crudo, cualquier ajuste lÃ³gico serÃ­a incorrecto.  
**El siguiente paso es inspecciÃ³n del stream, no cÃ³digo.**

---

## ðŸ” EVIDENCIA TÃ‰CNICA ADICIONAL

**Snoop Channel:** 1768837909.920 (RX-only, spy: 'in')  
**ExternalMedia:** stt-1768837909.919-1768837910257  
**Bridge de captura:** 1733d6d8-3de8-415c-8c2e-9da3482d3935  
**Audio Source usado:** 1768837909.920 (Snoop) âœ…  
**ExternalMedia direction:** 'both' âš ï¸ (posible problema)

**Log clave:**
```
ðŸŒ‰ [BRIDGE] Wired Audio: 1768837909.920 -> Bridge -> stt-1768837909.919-1768837910257 -> UDP
```
